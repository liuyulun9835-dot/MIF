# MIF Strategy Test v1.0 (t1)

> **Market Information Field 交易策略 - 测试版本**  
> 基于 MIF v2.1 理论 + MIF_CE_ICI_Spec_v1  
> 强调: 证伪优先 | 少做精做 | 认知边界

---

## 1. 背景与理论基础

### 1.1 核心理念

MIF (Market Information Field) 理论将市场视为**信息场**,而非价格序列:

**三个本体论承诺**:
1. **背景独立性**: 理论量不依赖价格刻度,适用于不同市场和时间框架
2. **信息守恒**: 市场信息在时间窗口内统计守恒 (内生regime假设)
3. **认知有界性**: 存在**可识别态(IS)**和**不可识别态(UIS)**,理论价值在于区分二者

**根本假设 H0**:
```
市场在任意时刻 t 处于两种认知态之一:
- 可识别态 (IS): 结构清晰,可提取信息租金
- 不可识别态 (UIS): 本质随机,预测不优于先验

理论目标: 识别何时处于IS,而非预测所有价格
```

### 1.2 理论层次

| 层级 | 问题 | 核心指标 | 角色 | 方法论 (关系论实现) |
|------|------|---------|------|-------------------|
| **环境层** | 市场信息是否可读? | Ω (可读性) | 门控 + 学习率 | **时间导数**: dΩ/dt, d²Ω/dt² 判断轨迹;<br>**概率分布**: 分位数阈值 q68/q95;<br>**关系判断**: Ω vs R背离检测 |
| **存在层** | 是否存在稳定结构? | I(Ψ) (结构清晰度) | 判断形状存在性 | **统计稳定性**: std_M(POC), std_M(u) 时间窗口方差;<br>**几何关系**: w_box (盒宽占比), u (相对位置);<br>**多维综合**: z-score标准化后加权 |
| **相位层** | 结构如何被推进? | E/R/D/ICI | 判断方向和模式 | **矢量表示**: E = (direction, magnitude, quality);<br>**相位分析**: R = z(I) × z(E) 内积;<br>**主导度**: D ∈ [-1,1] 归一化比例 |

**关键特性**:
- Ω **不参与** I(Ψ)计算 (避免重复计数)
- I(Ψ) **不回答**方向 (只判断形状)
- E **可替换** (DOM代理 → Cluster真实执行)
- **避免点判断**: 所有阈值用分位数,所有状态用导数/方差,所有方向用矢量

### 1.3 策略信条 (关系论与微分方程解思维)

**信条1: 关系优于点**
```
世界观:
事物的"意义"不在其绝对值,而在其与其他事物的关系

实现:
- 不用 Ω > 0.68 (绝对阈值)
- 用 Ω > quantile(Ω, 0.68) (相对分位)
- 不用 price (绝对坐标)
- 用 u ∈ [0,1] (相对位置)
```

**信条2: 动态优于静态**
```
世界观:
状态的演化方向比状态本身更重要
系统越复杂,越接近混沌,越需要高阶导数

实现:
- 不只看 Ω_t (零阶: 位置)
- 更看 dΩ/dt (一阶: 速度)
- 关键看 d²Ω/dt² (二阶: 加速度)

类比微分方程解:
dx/dt = f(x, t)
解的唯一性由初值条件 + 边界条件决定
高阶信息 → 更强的约束 → 更好的唯一性
```

**信条3: 矢量优于标量**
```
世界观:
方向信息与强度信息不可分离
单一数值丢失关键维度

实现:
- 不用 E_scalar ∈ ℝ (单一值)
- 用 E_vector = (direction, magnitude, quality) ∈ ℝ³

好处:
direction = 定性 (往哪走)
magnitude = 定量 (多强)
quality = 可行性 (能否执行)
```

**信条4: 分布优于期望**
```
世界观:
复杂系统本质概率性,期望值掩盖风险
完整分布保留不确定性信息

实现:
- 不输出 "开仓/拒绝" (二值判断)
- 输出 confidence ∈ [0,1] (概率分布)
- 不用 fixed_size (固定仓位)
- 用 size(confidence) (分布映射)

信息保留:
confidence = 0.61 → 刚过阈值,谨慎
confidence = 0.85 → 高置信,可重仓
```

**信条5: 窗口优于瞬时**
```
世界观:
单点判断脆弱,时间窗口平滑噪音
统计性质比瞬时值更鲁棒

实现:
- 不用 Ω_t (单点)
- 用 std_M(Ω) (M=12的窗口统计)
- 不用 "当前bar突破"
- 用 "过去5 bar持续上升"

物理意义:
点测量 → 量子涨落大
窗口平均 → 涨落√N衰减
```

**信条6: 相位优于幅度**
```
世界观:
信号的"同步性"比"强度"更关键
两个弱信号同相 > 一个强信号

实现:
R = z(I) × z(E)  (内积 → 相位一致度)
而非 |I| + |E|  (范数和 → 幅度叠加)

共振条件:
I↑ E↑ 同相 → R = +|I|·|E| (大)
I↑ E↓ 反相 → R = -|I|·|E| (负,拒绝)
```

**违反信条的风险等级**:
```
🔴 高危 (可能导致策略崩溃):
- 使用绝对阈值而非分位数
- 忽略高阶导数信息
- 单维度判断复杂问题

🟡 中危 (可能降低稳健性):
- 用期望值而非分布
- 用瞬时值而非窗口统计

🟢 低危 (可接受的工程简化):
- 在稳定regime用零阶近似
- 初始版本暂不实现三阶导数
```

---

## 2. 当前进度与现状

### 2.1 已验证的成果

**✓ 理论非随机性** (36天,51720个观测):
- 所有核心指标 p < 0.0001 (显著非随机)
- 跨尺度协变存在 (1m-1h)
- 异常状态可识别 (2.84%的观测,13.90x富集)

**✓ 数据管道稳定**:
- ATAS C# indicator v13/v14
- BTCUSDT 1m bars → JSONL导出
- DOM提取率 93.2% (固定20维数组)

**✓ 初步回测结果** (15m框架):
- 样本: 438笔交易
- 协变确认: E>0.40 + 1m/5m协变
- **问题**: 54%无成本胜率 → 18bp成本后 → 10.5%胜率

### 2.2 核心瓶颈

**问题1: 信号质量不足 (最致命)**
```
现状:
- 100个E>0.40的信号
- 能覆盖18bp成本的: 仅20个
- 80%的交易被磨损吃掉

根因:
- E缺少"质量"维度
- 只判断"有推动",不判断"推力强度"
- 无法区分散户追高 vs 机构建仓
```

**问题2: E测量粗糙**
```
当前E代理:
E* = 0.5·z(DOM梯度) + 0.5·z(顶层能量变化)

问题:
- DOM梯度 = 挂单意图,可能虚假
- 做市商可挂大单"虚张声势"
- 不反映真实成交
```

**问题3: 门控机制僵化**
```
当前规则:
Ω ≥ 0.68 → 可交易

问题:
- 0.68是固定阈值,不考虑市场regime
- 忽视Ω的时序轨迹 (上升 vs 下降)
- 未检测Ω与R的背离
```

---

## 3. 核心问题与解决思路

### 3.1 核心问题

**问题**: 如何从54%无成本胜率提升到可盈利水平?

**次级分解**:
```
问题1: 信号纯度不足 (80%低质量)
  ├─ 1.1: E缺少质量评估
  ├─ 1.2: 协变确认不充分
  └─ 1.3: 门控阈值过于宽松

问题2: 执行数据不准确
  ├─ 2.1: DOM代理无法区分真假推力
  └─ 2.2: 缺少真实成交数据

问题3: 风控机制单薄
  ├─ 3.1: 仓位固定,不随置信度调整
  ├─ 3.2: 退出规则机械
  └─ 3.3: 未检测失效场景
```

### 3.2 解决路径 (最小路径原则)

**阶段1: 数据升级 (必要条件)**

目标: 获取真实成交数据
```
修复: Cluster数据提取 (ATAS历史回放问题)
产出: delta_trade, volume, trades分布
验证: Cluster数据覆盖率 > 90%
```

**阶段2: E的三维化 (核心改进)**

目标: 从单一值 → 三维向量
```
E = (direction, magnitude, quality)

direction: sgn(E) - 推动方向
magnitude: |z(E)| - 推动强度
quality: 能否覆盖成本 (新增)
```

**质量计算**:
```python
quality = (
    0.4 × CVD_slope +      # 累积压力斜率
    0.3 × DEPIN +          # 单位成交的方向性
    0.3 × large_trade_pct  # 大单占比
)

# 归一化到 [0,1]
quality_normalized = percentile_rank(quality)
```

**阶段3: 动态门控 (置信度系统)**

目标: 软化硬阈值,引入概率判断
```python
# 当前 (硬阈值)
if Ω ≥ 0.68 and R > 0:
    开仓

# 改进 (概率门控)
confidence = (
    0.25 × Ω_static_score +     # 静态可读性
    0.25 × Ω_trend_score +      # 动态轨迹 (新)
    0.30 × E.quality +          # 执行质量 (新)
    0.20 × no_divergence_score  # 无背离 (新)
)

if confidence > 0.75:
    size = 1.0
elif confidence > 0.60:
    size = 0.5
else:
    拒绝交易
```

**Ω时序评分**:
```python
# Ω轨迹判断 (类比CVD运用)
# 微分方程解视角: 高阶导数提供更强约束
dΩ_dt = Ω_t - mean(Ω[-5:])        # 一阶导数: 速度
d²Ω_dt² = dΩ_dt - (Ω[-5] - Ω[-10])  # 二阶导数: 加速度

# 符合信条2: 动态优于静态
if dΩ_dt > 0 and d²Ω_dt² > 0:
    Ω_trend_score = 1.0  # 加速上升 ✓✓ (最强信号)
elif dΩ_dt > 0 and d²Ω_dt² < 0:
    Ω_trend_score = 0.6  # 减速上升 ✓ (动能衰减)
else:
    Ω_trend_score = 0.0  # 下降 ✗ (趋势反转)
```

⚠️ **点判断风险**:
```
🟡 中危: 使用固定窗口 (5, 10)
- 问题: 不同波动率regime下最优窗口可能不同
- 优化方向: 
  1. 自适应窗口: W = f(realized_volatility)
  2. 多尺度验证: 同时检查3/5/10窗口的一致性
  3. 用ACF确定特征时间尺度
```

**背离检测**:
```python
# Ω-R背离警告
# 符合信条1: 关系优于点 - 用相对分位数而非绝对值
R_pct = percentile_rank(R_t, R_history)
Ω_pct = percentile_rank(Ω_t, Ω_history)

divergence = (R_pct - Ω_pct) / 100  # 归一化到[-1,1]

if divergence > 0.3:
    # R强但Ω弱 → 结构脆弱
    # 物理意义: 相位一致但环境可读性不足 → 假信号
    no_divergence_score = 0.0
else:
    no_divergence_score = 1.0
```

⚠️ **点判断风险**:
```
🟡 中危: divergence阈值0.3
- 问题: 固定阈值未考虑不同regime的背离容忍度
- 优化方向:
  1. 历史背离分布: threshold = quantile(|divergence_history|, 0.75)
  2. 动态调整: 高波动期放宽,低波动期收紧
  3. 梯度映射: score = 1 - sigmoid(divergence / threshold)
```

**阶段4: 质量过滤 (提升纯度)**

目标: 只做top 20%高质量信号
```python
# 当前: 所有E>0.40
# 改进: 只做quality > q80

if E.magnitude > 0.40 and E.quality > quantile(E.quality, 0.80):
    if confidence > 0.60:
        开仓
```

---

## 4. 核心策略

### 4.1 三层过滤器

**Layer 1: 环境可读性**
```
指标: Ω (市场熵的反向)

静态规则:
- Ω < q68 → REJECT (雾太大)
- Ω ≥ q68 → 进入Layer 2

动态规则 (新):
- dΩ/dt < 0 → 警告 (可读性下降)
- Ω vs R背离 > 0.3 → REJECT (结构脆弱)
```

**Layer 2: 结构存在性**
```
指标: I(Ψ) = f(w_box, POC稳定, u稳定)

规则:
- I(Ψ) 低 → REJECT (结构不清晰)
- I(Ψ) 高 → 进入Layer 3

计算:
C_comp = 1 - w_box  (紧致度)
z_POC = -z(std_M(POC))  (POC稳定)
z_u = -z(std_M(u))  (位置稳定)

I(Ψ) = EMA_9[(z_comp + z_POC + z_u) / 3]
```

**Layer 3: 相位一致性**
```
指标: E (执行推进), R (共振), D (主导度)

E三维向量:
- direction = sgn(E)
- magnitude = |z(E)|
- quality = f(CVD_slope, DEPIN, large_trades)

> 【V14_Final 阶段说明】E 作为向量保留 (direction, magnitude) 两维；`quality` 暂未启用（等待 MifClusterExporter）。所有阈值以分位数表达（详见 Relationalism Supplement 与 v2 数据规范）。

R = z(I(Ψ)) × z(E)  (共振强度)
D = (|z(I(Ψ))| - |z(E)|) / (|z(I(Ψ))| + |z(E)|)  (主导度)

规则:
- R < 0 → REJECT (反相)
- R ≥ z_R (如0.25) → 进入方向判断
```

### 4.2 方向决策 (DIR-v0)

**降噪优先** (不做什么):
```
1. Ω < q68 → 不给方向
2. R < 0 → 不给方向 (反相)
3. z(ICI) < z* → 不给方向 (相位一致度不足)
4. E.quality < q80 → 不给方向 (质量不足,新增)
5. confidence < 0.60 → 不给方向 (置信度不足,新增)
6. Structure-led但0.3<u<0.7 → 不给方向 (不在边缘)
```

⚠️ **点判断风险标注**:
```
🟡 中危: 条件6使用u的硬阈值 (0.3, 0.7)
- 问题: 不同市场/波动率下边缘定义可能不同
- 风险: 可能错过有效信号或产生假阳性
- 优化方向: 
  1. 用分位数: u < quantile(u, 0.3) 和 u > quantile(u, 0.7)
  2. 考虑POC位移速度: 不只看u位置,还看du/dt
  3. 结合w_box: 边缘定义与盒宽相关
  
🟢 低危: 条件1,3,4,5已使用分位数/z-score (符合信条)

🟢 低危: 条件2使用符号判断 (R<0)
- 这是相位反转的本质判断,不是任意阈值
- 符合信条6 (相位优于幅度)
```

**给方向** (做什么):

**模式1: Belief-led (执行主导)**
```
判据:
- D < -0.25
- z(R) ≥ 0.25
- E.quality > q80 (新增)

方向:
- direction = sgn(E)  # 符合信条3: 矢量优于标量

确认:
- 15m框架: 过去15m内有1m/5m的E同向上穿
- dE/dt > 0 (加速中,新增)  # 符合信条2: 动态优于静态

置信度 (符合信条4: 分布优于期望):
- 基础: 0.6
- E.quality ∈ q80-q90: +0.1
- E.quality > q90: +0.2
```

⚠️ **点判断风险**:
```
🟡 中危: D阈值 -0.25
- 问题: 固定阈值,未考虑不同市场的主导度分布
- 优化方向:
  1. 自适应阈值: D_threshold = quantile(D_history, 0.25)
  2. 模糊边界: D ∈ [-0.3, -0.2] 时降权而非硬截断
  3. 结合|D|: 主导显著性也应纳入考量
  
🟢 低危: z(R) ≥ 0.25 使用z-score
- 已归一化,跨市场适用
- 符合关系论原则

🟡 中危: dE/dt的计算窗口未明确
- 优化方向: 明确用W=5的窗口,与dΩ/dt一致
```

**模式2: Structure-led (结构主导)**
```
判据:
- D > +0.25  # 🟡 同样的固定阈值问题
- z(R) ≥ 0.25
- u ≤ 0.3 或 u ≥ 0.7 (在边缘)  # 🟡 硬阈值

方向:
- u ≤ 0.3 → 做多 (下沿回归)
- u ≥ 0.7 → 做空 (上沿回归)

确认 (符合信条5: 窗口优于瞬时):
- POC未大幅位移: std_5(POC) < threshold
- 不只看当前u,还看过去5 bar的稳定性

置信度:
- 基础: 0.6
- I(Ψ) > q75: +0.1
- absorption高 (DOM抵抗力强): +0.2
```

⚠️ **点判断风险**:
```
🟡 中危: u边缘阈值 (0.3, 0.7)
- 问题: 未考虑盒宽w_box的影响
  - w_box=0.2时,边缘很窄 → 0.3/0.7可能太宽松
  - w_box=0.5时,边缘很宽 → 0.3/0.7可能太严格
- 优化方向:
  1. 动态边缘: u_low = w_box/2, u_high = 1 - w_box/2
  2. 梯度函数: edge_strength = min(u, 1-u) / (w_box/2)
  3. 历史分布: 用u在历史上的分位数而非绝对值

🟡 中危: std_5(POC)的阈值未明确
- 优化方向: 
  threshold = quantile(std_rolling(POC, W=5), 0.3)
  即只在POC稳定性前30%时才认为"未大幅位移"
```

**模式3: Co-dominant (共主导)**
```
判据:
- |D| < 0.25
- z(R) ≥ 0.25

方向:
- direction = sgn(E), 但降权

确认:
- 需要EMA(20)同向
- E.quality > q75

置信度:
- 基础: 0.5 (低于其他模式)
- 需要额外确认才能开仓
```

#### （新增）多尺度结构确认 · MSI

**目的**：用跨时间尺度一致性过滤假趋势、保留早期结构参与机会。

**核心量：**
- `C_ms`：多尺度相位一致性（例：corr([Ω_5m, Ω_15m, Ω_30m])）
- `ΔΩ_multi`：多尺度延续速率（mean(dΩ/dt across {5m,15m,30m} )）
- `MSI_weight = sigmoid((C_ms - 0.5)/0.1)`：将一致性映射为置信权重

**开仓门槛（在原有 Ω/I/ICI 条件之上叠加，不替代）**：
- `MSI_weight > 0.6` → 结构跨尺度协变强，信号可信  
- 允许**早介入**：若短周期先动、但中周期开始响应（C_ms 上升且 ΔΩ_multi ≥ 0）→ 小仓试探

**伪码：**
```python
if base_entry_condition(Ω, I, ICI):  # 保留原有条件
    C_ms = corr([Ω_5m, Ω_15m, Ω_30m])
    dO = [dΩ_dt_5m, dΩ_dt_15m, dΩ_dt_30m]
    ΔΩ_multi = mean(dO)
    MSI_weight = sigmoid((C_ms - 0.5)/0.1)

    if MSI_weight > 0.6:
        open_position(confidence=MSI_weight)   # 正常入场
    elif MSI_weight > 0.5 and ΔΩ_multi >= 0:
        open_probe(size = min_base_size * 0.5) # 试探入场
    else:
        skip()
```

### 4.3 仓位管理

**开仓仓位**:
```python
# 固定最大仓位 (基于Ω_weekly初值)
if Ω_weekly_initial > 0.6:
    max_position = 1.0
elif Ω_weekly_initial > 0.5:
    max_position = 0.7
else:
    max_position = 0.5

# 根据置信度动态调整
position_size = max_position × ((confidence - 0.6) / 0.4)

# 分段映射
if confidence > 0.75:
    size = max_position
elif confidence > 0.60:
    size = max_position × 0.5
else:
    size = 0  # 拒绝
```

##### （新增）MSI引导的自适应加减仓

- **加仓**：当 `ΔΩ_multi > 0` 且 `C_ms` 上升 → 结构延续被强化  
- **减仓**：当 `ΔΩ_multi < 0` 或 `C_ms` 下降 → 结构动能衰减

**伪码：**
```python
if ΔΩ_multi > 0 and C_ms is rising:
    add_position(size = current_position * MSI_weight)
elif ΔΩ_multi < 0 and C_ms is falling:
    reduce_position(size = current_position * (1 - MSI_weight))
```

> 含义：允许**小结构快进快退**，**大结构慢进慢退**；仓位与“结构延续置信度”同向变化。

### 4.4 多尺度级联追踪 【⚠️ 需要验证的理论】

> **警告**: MSI理论假设N_MSI≈4-6 bar为市场结构常数，需要跨时间框架验证

#### 4.4.1 核心思想
不是"固定持有N bar"，而是"动态追踪能量级别"
- 每个时间框架观察4-6 bar（MSI常数）
- 根据级联/衰减条件动态升降级
- 让利润奔跑，捕捉肥尾

#### 4.4.2 最小结构单元(MSI)
```python
# 【需要验证】跨尺度不变假设
N_MSI = {
    '1m': 5-7,    # 预测值，需验证
    '5m': 3-5,    # 预测值，需验证
    '15m': 4-6,   # 已初步验证
    '30m': 4-6,   # 预测值，需验证
    '1h': 4-6     # 预测值，需验证
}
```

#### 4.4.3 级联检测条件
在每个tf观察4-6 bar，判断：
- 能否升级？(级联检测)
- 应否降级？(衰减检测)

#### 4.4.4 状态转移逻辑
```
[1m观察] → [5m观察] → [15m开仓]
                           ↓
                       Bar 1-2确认
                           ↓
                    ┌──────┴──────┐
                 失败           成功
                 退出        Bar 3-6
                              ↓
                        级联检测
                    ┌──────┴──────┐
                 无级联         有级联
                Bar 6退出      升级30m
```

**⚠️ 需要验证的关键假设**:
1. H1: N_MSI在不同tf上确实≈4-6 bar
2. H2: 级联事件可以在15m的3-4 bar时识别
3. H3: 衰减可以在降级后的2-4 bar内判断

### 4.5 退出规则

**立即退出**:
```
1. Ω < q68 (可读性丧失)
2. R由正转负 (相位翻转)
3. confidence跌破0.3 (置信度崩溃)
4. Ω轨迹反转 (dΩ/dt由正转负且持续2 bar)
5. Belief-led中E反向持续2 bar
```

**减仓50%**:
```
1. confidence跌至0.3-0.5区间
2. E.quality跌破q50
3. 检测到Ω-R背离 > 0.2
```

**到期平仓**:
```
1. 达到预定时间窗口 (15m/30m/1h)
2. 未触发其他退出条件
```

**MSI动态退出** 【⚠️ 需要验证】:
```python
# 不再是固定时间窗口退出
def dynamic_exit_logic(position):
    current_tf = position['current_tf']
    bars_in_tf = position['bars_in_current_tf']

    # MSI完成退出
    if bars_in_tf >= N_MSI[current_tf] and not has_cascade:
        return "EXIT"  # 无级联，MSI完成后退出

    # 级联升级 (不退出，继续追踪)
    if has_cascade_signal(current_tf):
        return "UPGRADE"  # 升级到高tf

    # 衰减降级
    if detect_decay(position):
        return "DOWNGRADE"  # 降级监控
```

##### （新增）MSI 退相干退出原则

仅短周期震荡不触发退出；**跨尺度退相干**才视为结构结束：

**触发式样：**
- `Ω_5m↓ & Ω_15m↓ & Ω_30m 无响应/走弱` → `trigger_exit("MSI退相干")`
- （可选）若显式贝叶斯置信度坍塌：`posterior_belief < 0.3` → `close_all("结构信念崩塌")`

**伪码：**
```python
if falling(Ω_5m) and falling(Ω_15m) and stale_or_falling(Ω_30m):
    trigger_exit("MSI退相干")

if posterior_belief < 0.3:
    close_all_positions("结构信念崩塌")
```

---

## 5. 次级问题与解决方案

### 5.1 问题: Cluster数据滞后性

**担忧**: Cluster依赖价格,是否引入迟滞?

**解决**:
```
分析:
Price变化 → Cluster记录 ≈ 0-1秒
Price变化 → 人工决策 → 下单 ≈ 1-5秒

结论:
在15m-1h窗口,Cluster滞后可忽略
我们关心"过去15分钟谁赢了",非"下一秒"
```

**验证**:
- 回测时对比DOM代理 vs Cluster的信号差异
- 如果Cluster滞后导致missed entries > 10% → 调整策略

---

### 5.2 问题: 协变确认可能是假信号

**担忧**: 协变可能只是噪音的多尺度重复

**证据**:
- Price_Analysis显示30分钟准确率29% (低于50%)
- 协变事件后价格接近随机

**解决**:
```
修正:
- 协变不再是"充分条件"
- 改为"必要条件之一"

新规则:
协变 + Ω上升 + E.quality>q80 + 无背离 → 才开仓

单纯协变 → 拒绝
```

**验证**:
- A/B测试: 有协变 vs 无协变的胜率差异
- 如果协变无效 (p>0.05) → 移除协变要求

---

### 5.3 问题: 贝叶斯框架可能过度工程

**担忧**: 
- 数据不足 (36天)
- 先验/似然难以准确校准
- 独立性假设可能不成立

**解决**:
```
阶段1 (当前):
使用简单加权,不上贝叶斯

confidence = 0.25×Ω_static + 0.25×Ω_trend + 
             0.30×E.quality + 0.20×no_divergence

阶段2 (积累足够数据后):
- 统计各因子的历史表现
- 用经验分布估计似然比
- 再考虑贝叶斯更新
```

**验证**:
- 先验证简单加权是否有效
- 如有效,积累1000+样本后再上贝叶斯

---

### 5.4 问题: 可识别态 ≠ 可盈利交易

**担忧**: 
- Ω高 = 结构清晰
- 但可能是"已定价完毕"
- 后续是随机游走

**解决**:
```
假设修正:
价值可能在"拐点",非"平稳期"

策略调整:
1. 识别Ω从低到高的转折点
   (dΩ/dt上穿0 + Ω>q68)

2. 识别E正在打破结构
   (E.quality极高 + Ω开始下降)

避免:
- Ω持续高位的静态区域
- R高但无动态变化
```

**验证**:
- 对比"Ω上升期"vs"Ω高位期"的胜率
- 如拐点更优 → 调整开仓触发为"上穿事件"

---

### 5.5 问题: 时间窗口动态选择过拟合风险

**担忧**: 自由度太高,样本外失效

**解决**:
```
阶段1 (当前):
固定30m窗口 (90%时间)

阶段2 (验证有效后):
仅在极端情况切换 (10%时间)

切换规则 (严格):
- 15m: Ω>0.85 AND 协变>q95 AND E.quality>q90
- 1h:  Ω<0.7 AND Ω>0.68 AND 长期趋势明确
```

**验证**:
- 样本内 vs 样本外窗口选择的差异
- 如过拟合严重 → 永久固定30m

---

## 6. 风险与边界

### 6.1 理论边界

**MIF理论不适用的情况**:
```
1. 极端事件 (Black Swan)
   - OP (Overload) 发生时
   - 测不准关系失效

2. 强外源期
   - |S_ext| ≫ 平均值
   - 重大新闻/政策变化
   - 标记为"外源期",暂停交易

3. 低流动性市场
   - n_levels < 20
   - DOM稀疏
   - 理论可能不适用
```

### 6.2 策略风险

**风险1: 数据质量**
```
Cluster提取失败 → E质量评估失效
缓解:
- 监控Cluster覆盖率
- 覆盖率 < 80% → 降级为DOM代理
- 记录warning,但不停止交易
```

**风险2: 过度优化**
```
5-6个过滤条件 → 样本外失效
缓解:
- 始终保留"无条件"基线组
- A/B测试每个条件的增量价值
- p < 0.05才保留
```

**风险3: 市场regime切换**
```
牛市训练 → 熊市失效
缓解:
- 每月重新校准分位数阈值
- 监控元认知校准误差
- error > 0.15 → 暂停30天
```

### 6.3 执行风险

**成本模型**:
```
假设:
- Taker fee: 0.05%
- 滑点: 0.05%
- 总成本: 0.10% per side = 0.20% round-trip

对于15m窗口,20bp是重要门槛
E.quality必须预测能覆盖此成本
```

**流动性风险**:
```
大单可能无法成交
缓解:
- 仓位上限: 日均成交量的1%
- 分批建仓 (2-3笔)
```

---

## 7. 术语对照表

### 7.1 MIF核心术语

| 符号 | 全称 | 含义 | 计算 |
|------|------|------|------|
| **ε** | epsilon能量 | DOM层级能量 | ask_vol[], bid_vol[] |
| **Ψ** | Configuration | 能量位形 | {ε(p,s,t)} |
| **Ω** | Omega相干度 | 市场可读性 | 1 - H(eps)/log(N) |
| **H_m** | 结构熵 | 能量分布熵 | -Σp_i log(p_i) |
| **I_em** | 嵌入互信息 | 买卖相关性 | I(buy; sell) |
| **φ** | 相位差 | 买卖质心相位 | arctan2(Ē_buy - Ē_sell, ...) |
| **div J** | 信息通量散度 | 信息流动方向 | ∂H_m/∂t - ∂I_em/∂t |

### 7.2 策略指标 (新增)

| 符号 | 全称 | 含义 | 计算 | 数据源 |
|------|------|------|------|--------|
| **I(Ψ)** | 结构清晰度 | 形状存在性 | f(w_box, POC稳定, u稳定) | DOM |
| **E** | 执行推进 | 推动强度 | (direction, magnitude, quality) | Cluster |
| **E.direction** | 推动方向 | 极性 | sgn(delta_trade) | Cluster |
| **E.magnitude** | 推动强度 | 归一化幅度 | \|z(delta_trade)\| | Cluster |
| **E.quality** | 推动质量 | 覆盖成本能力 | f(CVD斜率, DEPIN, 大单) | Cluster |
| **R** | 共振强度 | 同相程度 | z(I(Ψ)) × z(E) | I(Ψ) + E |
| **D** | 主导度 | 谁说了算 | (\|z(I(Ψ))\| - \|z(E)\|) / (\|z(I(Ψ))\| + \|z(E)\|) | I(Ψ) + E |
| **ICI_new** | 相位一致度 | Ω调制的一致性 | z(I(Ψ)) + z(E) + b·R, λ(Ω)迭代 | I(Ψ) + E + Ω |
| **ρ** | 紧迫度比 | 买卖紧迫度 | u_buy / u_sell | Cluster |

### 7.3 拍卖理论指标 (新引入)

| 指标 | 含义 | 计算 | 用途 |
|------|------|------|------|
| **delta_trade** | 买卖成交差 | Σ(buy_vol - sell_vol) | E.direction |
| **CVD** | 累积delta | cumsum(delta_trade) | E.magnitude |
| **CVD_slope** | CVD斜率 | (CVD[-1] - CVD[-5]) / 5 | E.quality |
| **DEPIN** | 归一化方向性 | delta / sqrt(volume) | E.quality |
| **large_trade_pct** | 大单占比 | (vol > q90).count() / n | E.quality |
| **absorption** | 吸收强度 | DOM变化 / 成交量 | Structure-led置信度 |

### 7.4 禁止使用的混淆术语

| ❌ 错误 | ✓ 正确 | 说明 |
|---------|--------|------|
| urgency_ratio | ρ | 统一为希腊字母 |
| u_ratio | ρ | 同上 |
| urgency_factor | (已废弃) | 从ε定义中移除 |
| clarity | I(Ψ) | 避免模糊 |
| ICI (旧版) | ICI_new | 明确版本 |

### 7.5 ATAS数据源术语

| 上下文 | Ask | Bid | 说明 |
|--------|-----|-----|------|
| **DOM** | 卖方挂单 | 买方挂单 | 待成交的订单 |
| **Cluster** | 买方主动成交 | 卖方主动成交 | 已成交的订单 |

**警告**: ATAS中Ask/Bid在DOM和Cluster含义相反,代码中通过类型名区分

---

## 8. 下一步行动

### 8.1 Phase 1: 数据修复 (Week 1)

**目标**: 修复Cluster数据提取

**任务**:
1. 解决ATAS历史回放DOM优先级问题
2. 验证Cluster数据覆盖率 > 90%
3. 导出格式: JSONL包含buy_vol[], sell_vol[], delta, volume

**验证**:
- 36天数据完整性检查
- 对比实时 vs 历史回放的差异

### 8.2 Phase 2: E三维化 (Week 2)

**目标**: 实现E = (direction, magnitude, quality)

**任务**:
1. 计算CVD, DEPIN, large_trade_pct
2. 实现quality评分函数
3. 回测对比DOM代理 vs Cluster真实

**验证**:
- E.quality与后续收益的相关性
- top 20% quality信号的胜率

### 8.3 Phase 3: 动态门控 (Week 3)

**目标**: 实现置信度系统

**任务**:
1. Ω时序轨迹判断 (dΩ/dt, d²Ω/dt²)
2. Ω-R背离检测
3. confidence综合评分
4. 仓位与置信度映射

**验证**:
- confidence与实际胜率的校准误差
- 分段(0.6-0.7, 0.7-0.8, 0.8+)的表现差异

### 8.4 Phase 4: 回测验证 (Week 4)

**目标**: 全面回测新策略

**测试**:
1. 无条件基线 (所有Ω>q68)
2. +协变确认
3. +E.quality过滤
4. +置信度门控
5. 完整策略

**关键指标**:
```
目标:
- 胜率: > 25% (现实预期)
- 夏普: > 0.5
- 最大回撤: < 15%
- 盈利因子: > 1.5

接受:
- 胜率15-25%,但高质量
- 交易次数大幅减少 (400 → 80)
- 单笔盈亏比 > 2.0
```

---

## 9. 成功标准

### 9.1 不期望

```
❌ 预测所有价格变动
❌ 胜率 > 50%
❌ 零假阳性
❌ 所有市场regime都有效
```

### 9.2 期望

```
✓ 识别何时可预测 (IS vs UIS)
✓ 在IS态: 胜率 > 25%, 盈亏比 > 2.0
✓ 在UIS态: 拒绝交易或极轻仓
✓ E.quality有区分度: top 20% vs bottom 80%显著差异
✓ confidence与实际胜率校准误差 < 15%
✓ 策略在30天样本外仍有效 (p < 0.05)
```

### 9.3 失效标准 (范式危机)

**立即停止交易,启动30天审查**:
```
满足以下3项或以上:
□ 相关性衰减 (Ω与胜率 corr < 0.1)
□ 止损频率异常 (> 60%)
□ 逆向盈亏 (UIS赚钱, IS亏钱)
□ E.quality无区分度 (top 20% vs bottom 80%, p > 0.05)
□ 元认知失准 (confidence校准误差 > 0.15)
□ 样本外完全失效 (30天胜率 < 10%)
```

---

## 10. 附录

### 10.1 关键公式速查

**基础量 (零阶: 状态)**:
```python
# Ω (可读性)
Ω = 1 - H(eps) / log(N)
H(eps) = -Σ p_i log(p_i)

# I(Ψ) (结构清晰度)
C_comp = 1 - w_box
z_POC = -z(std_M(POC))  # M=12窗口统计
z_u = -z(std_M(u))
I(Ψ) = EMA_9[(C_comp + z_POC + z_u) / 3]

# E (执行推进 - Cluster版本)
delta_trade = Σ(buy_vol - sell_vol)
CVD = cumsum(delta_trade)
E.direction = sgn(delta_trade)
E.magnitude = |z(delta_trade)|
E.quality = 0.4×CVD_slope + 0.3×DEPIN + 0.3×large_trade_pct
```

**动力学量 (一阶/二阶: 导数)**:
```python
# 符合信条2: 动态优于静态
# 微分方程解视角: 高阶导数 → 更强约束

# 一阶导数 (速度)
dΩ_dt = (Ω_t - mean(Ω[-W:])) / Δt    # W=5
dE_dt = (E_t - E_{t-1}) / Δt

# 二阶导数 (加速度)
d²Ω_dt² = (dΩ_dt - dΩ_dt_{t-W}) / Δt

# 物理意义:
# dΩ/dt > 0: 可读性提升
# d²Ω/dt² > 0: 可读性加速提升 (最强信号)
# d²Ω/dt² < 0: 可读性减速提升 (动能衰减,警告)
```

**相位量 (内积: 关系)**:
```python
# 符合信条6: 相位优于幅度
# R, D
R = z(I(Ψ)) × z(E)  # 内积 → 同相/反相
D = (|z(I(Ψ))| - |z(E)|) / (|z(I(Ψ))| + |z(E)|)

# R的物理意义:
# R > 0: I和E同相 (共振)
# R < 0: I和E反相 (冲突)
# |R|大: 相位关系显著
```

**概率量 (分布: 置信度)**:
```python
# 符合信条4: 分布优于期望
# 置信度 (概率而非二值)
confidence = (
    0.25 × Ω_static_score +     # 零阶
    0.25 × Ω_trend_score +      # 一阶+二阶
    0.30 × E.quality +          # 质量分布
    0.20 × no_divergence_score  # 关系一致性
)

# 仓位 (分布映射)
size = max_position × (confidence - 0.6) / 0.4  # 线性映射到[0,1]
```

**关系量 (分位数: 背景独立)**:
```python
# 符合信条1: 关系优于点
# 所有阈值都用分位数

Ω_threshold = quantile(Ω_history, 0.68)  # 而非固定0.68
E_quality_high = quantile(E.quality, 0.80)
D_belief_threshold = quantile(D_history, 0.25)  # 而非固定-0.25
```

### 10.2 策略信条遵循度检查

**完全符合信条 (✓)**:

| 信条 | 实现位置 | 方法 |
|------|---------|------|
| 关系优于点 | Ω门控 | 用quantile(Ω, 0.68)而非固定0.68 |
| 关系优于点 | E.quality | 用percentile_rank归一化 |
| 动态优于静态 | Ω评分 | 计算dΩ/dt, d²Ω/dt² |
| 动态优于静态 | Belief-led | 检查dE/dt加速度 |
| 矢量优于标量 | E定义 | E = (direction, magnitude, quality) |
| 分布优于期望 | 置信度 | 输出confidence ∈ [0,1],不是二值 |
| 窗口优于瞬时 | I(Ψ) | std_M(POC), std_M(u), M=12 |
| 相位优于幅度 | R定义 | R = z(I)×z(E) 内积,非|I|+|E| |

**部分符合,存在优化空间 (🟡)**:

| 位置 | 当前实现 | 问题 | 优化方向 |
|------|---------|------|---------|
| DIR-v0条件6 | u ∈ [0.3, 0.7] | 硬阈值,未考虑w_box | u_edge = f(w_box, quantile) |
| Belief-led判据 | D < -0.25 | 固定阈值 | quantile(D, 0.25) |
| Structure-led判据 | D > +0.25 | 固定阈值 | quantile(D, 0.75) |
| 背离检测 | divergence > 0.3 | 固定阈值 | quantile(\|div\|, 0.75) |
| Ω时序窗口 | W = 5, 10 | 固定窗口 | 自适应: W = f(volatility) |
| POC稳定性 | std_5(POC) < threshold | threshold未明确 | quantile(std_rolling, 0.3) |

**合理的工程简化 (🟢)**:

| 位置 | 简化 | 理由 |
|------|------|------|
| R < 0判断 | 符号判断 | 相位反转的本质,非任意阈值 |
| z-score阈值 | z(R) ≥ 0.25 | 已归一化,跨市场适用 |
| 固定20层 | DOM/Cluster数组 | 工程实现需要,不影响相对关系 |

**改进优先级**:

```
Phase 1（V14_Final, DOM-only, 冻结参数）：
□ 用quantile替换所有硬阈值 (D, divergence, u_edge)
□ 明确所有窗口参数 (dΩ/dt用W=5, POC用M=12)

Phase 2：启动 MifClusterExporter 独立项目：产出 Cluster 精确字段（buy/sell 20 层、trades_count、CVD、large_trade_pct 等），用于后续 E.quality 与精确 ρ 校验。
□ 建立独立 exporter .csproj 并对接数据契约
□ 导出并校验 Cluster 精确字段，完成 ρ(dom_proxy) vs ρ(cluster_true) 偏差评估

Phase 3 (t3, 优化后):
□ 自适应窗口: W = f(realized_volatility)
□ 多尺度一致性检查: 3/5/10窗口的导数对齐
```

---

### 10.3 决策树

```
开仓决策:
├─ Ω < q68? → REJECT
├─ Ω轨迹下降? → REJECT
├─ R < 0? → REJECT
├─ E.quality < q80? → REJECT
├─ confidence < 0.60? → REJECT
├─ Ω-R背离 > 0.3? → REJECT
└─ 通过所有检查 → 判断模式
    ├─ D < -0.25: Belief-led → direction = sgn(E)
    ├─ D > +0.25 且 u在边缘: Structure-led → 回归策略
    └─ |D| < 0.25: Co-dominant → 谨慎跟随

持仓决策:
├─ Ω < q68? → 立即平仓
├─ R转负? → 立即平仓
├─ confidence < 0.3? → 立即平仓
├─ Ω轨迹反转? → 立即平仓
├─ confidence ∈ [0.3, 0.5]? → 减仓50%
├─ 检测到级联? → 升级追踪 【⚠️ MSI理论，需验证】
├─ 检测到衰减? → 降级监控 【⚠️ MSI理论，需验证】
└─ 达到N_MSI且无级联? → MSI完成退出 【⚠️ MSI理论，需验证】
```

---

**版本**: t1 (Test Version 1)  
**日期**: 2025-11-09  
**状态**: 待验证  
**基于**: MIF v2.1 + MIF_CE_ICI_Spec_v1  
**核心理念**: 少做精做 | 证伪优先 | 认知边界

**下一版本**: t2将在Phase 1-4完成后发布,包含回测结果和策略调整
